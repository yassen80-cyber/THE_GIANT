<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨ | THE GIANT</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: "Cairo", sans-serif;
    background: radial-gradient(circle at top, #0b0f19, #000);
    color: #fff;
    min-height: 100vh;
    overflow-x: hidden;
  }
  header {
    background: linear-gradient(90deg,#00b2ff,#16a34a);
    padding: 18px 25px;
    text-align: center;
    font-size: 22px;
    font-weight: 700;
    color: #fff;
    border-bottom: 2px solid #1f2937;
    letter-spacing: 0.5px;
  }
  main {
    max-width: 600px;
    margin: 40px auto;
    background: rgba(31,41,55,0.95);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 0 30px rgba(0,255,255,0.1);
    text-align: center;
    position: relative;
  }
  h2 {
    color: #22d3ee;
    font-size: 24px;
    margin-bottom: 15px;
  }
  .stat {
    font-size: 18px;
    margin: 12px 0;
    background: #111827;
    padding: 14px;
    border-radius: 12px;
    transition: transform 0.3s;
    border: 1px solid rgba(255,255,255,0.05);
  }
  .stat:hover {
    transform: scale(1.03);
  }
  .progress-bar {
    height: 22px;
    background: #374151;
    border-radius: 12px;
    overflow: hidden;
    margin: 25px 0;
  }
  .progress-bar-inner {
    height: 100%;
    background: linear-gradient(90deg,#22d3ee,#3b82f6,#16a34a);
    width: 0%;
    transition: width 1.5s ease-in-out;
  }
  .message {
    margin-top: 15px;
    font-size: 18px;
    font-weight: 600;
    color: #16a34a;
  }
  .back-btn {
    display: block;
    margin: 30px auto 0;
    text-decoration: none;
    background: linear-gradient(45deg,#00b2ff,#16a34a);
    color: #fff;
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 17px;
    transition: all 0.3s ease;
    max-width: 200px;
  }
  .back-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0,255,255,0.2);
  }
</style>
</head>
<body>
  <header>ğŸ“Š Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ</header>
  <main>
    <h2 id="studentName">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
    <div class="stat" id="examStats">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª: -</div>
    <div class="stat" id="homeworkStats">Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª: -</div>
    <div class="stat" id="totalPerformance">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: -</div>
    <div class="progress-bar"><div class="progress-bar-inner" id="progress"></div></div>
    <div class="message" id="message">Ø¬Ø§Ø±Ù Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„Ùƒ...</div>
    <a href="dashboard.html" class="back-btn">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
  </main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDW80ZbwOB7QHHW76kSL9cqlzMoyPFZ7nI",
  authDomain: "ylearn-fe1fa.firebaseapp.com",
  databaseURL: "https://ylearn-fe1fa-default-rtdb.firebaseio.com",
  projectId: "ylearn-fe1fa",
  storageBucket: "ylearn-fe1fa.appspot.com",
  messagingSenderId: "1092852055944",
  appId: "1:1092852055944:web:85c3df7cf4c0cbcdca043d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  try {
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
    const [userSnap, purchasedSnap, allCoursesSnap, resultsSnap, hwResultsSnap] = await Promise.all([
      get(ref(db, `users/${user.uid}`)),
      get(ref(db, `students/${user.uid}/purchased`)), // Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ØµØ­ÙŠØ­
      get(ref(db, `courses`)),
      get(ref(db, `results/${user.uid}`)), // Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©
      get(ref(db, `homeworkResult/${user.uid}`)) // Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª
    ]);

    // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
    const userData = userSnap.val() || {};
    document.getElementById("studentName").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${userData.fullName || 'Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø¨Ø·Ù„'} ğŸ‘‹`;

    let totalExams = 0, solvedExams = 0;
    let totalHWs = 0, solvedHWs = 0;

    const purchasedIds = purchasedSnap.exists() ? Object.keys(purchasedSnap.val()) : [];
    const examsDone = resultsSnap.exists() ? resultsSnap.val() : {};
    const hwDoneRecords = hwResultsSnap.exists() ? Object.values(hwResultsSnap.val()) : [];

    if (allCoursesSnap.exists() && purchasedIds.length > 0) {
      const courses = allCoursesSnap.val();

      purchasedIds.forEach(id => {
        const c = courses[id];
        if (c && c.content) {
          Object.entries(c.content).forEach(([cid, content]) => {
            // Ù…Ù†Ø·Ù‚ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
            if (content.type === "Ø§Ù…ØªØ­Ø§Ù†") {
              totalExams++;
              if (examsDone[cid]) solvedExams++;
            }
            // Ù…Ù†Ø·Ù‚ Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª
            if (content.type === "ÙˆØ§Ø¬Ø¨") {
              totalHWs++;
              // Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
              const isSolved = hwDoneRecords.some(r => r.examTitle === content.title || r.title === content.title);
              if (isSolved) solvedHWs++;
            }
          });
        }
      });
    }

    // Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    const totalTasks = totalExams + totalHWs;
    const totalSolved = solvedExams + solvedHWs;
    const finalPercent = totalTasks > 0 ? Math.round((totalSolved / totalTasks) * 100) : 0;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.getElementById("examStats").textContent = `ğŸ“˜ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: ${solvedExams} Ù…Ù† ${totalExams}`;
    document.getElementById("homeworkStats").textContent = `ğŸ“ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ù„Ù…Ø©: ${solvedHWs} Ù…Ù† ${totalHWs}`;
    document.getElementById("totalPerformance").textContent = `ğŸŒŸ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: ${finalPercent}%`;
    
    document.getElementById("progress").style.width = finalPercent + "%";

    // Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­ÙÙŠØ²
    const msg = document.getElementById("message");
    if (finalPercent === 100) { msg.textContent = "ğŸš€ Ù…Ù…ØªØ§Ø²! Ø£Ù†Øª Ø¹Ù…Ù„Ø§Ù‚ Ø­Ù‚ÙŠÙ‚ÙŠ Ø£ØªÙ…Ù…Øª ÙƒÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…"; msg.style.color = "#00ff9d"; }
    else if (finalPercent >= 50) { msg.textContent = "ğŸ‘ Ø±Ø§Ø¦Ø¹! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªÙ‚Ø¯Ù…ØŒ Ø£Ù†Øª ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚"; msg.style.color = "#22d3ee"; }
    else { msg.textContent = "ğŸ’ª Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†! Ù…Ø³ØªÙ‚Ø¨Ù„Ùƒ ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ù…Ø¬Ù‡ÙˆØ¯"; msg.style.color = "#fb923c"; }

  } catch (err) {
    console.error(err);
    document.getElementById("message").textContent = "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.";
  }
});
</script>
</body>
</html>
