<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ§  Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†- Ù…Ù†ØµØ© THE GIANT</title>
<style>
  body {margin:0;font-family:"Cairo",sans-serif;background:#0b0f19;color:#fff;min-height:100vh;}
  header {background:#111827;padding:1rem 1.5rem;display:flex;justify-content:center;align-items:center;box-shadow:0 0 10px rgba(0,0,0,0.4);}
  header h1 {color:#00b2ff;margin:0;font-size:1.2rem;}
  .exam-container {max-width:950px;margin:auto;padding:1rem;}
  .exam-title {text-align:center;font-size:1.4rem;color:#00b2ff;margin:1.5rem 0 1.5rem;}
  .stats-bar {display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;margin-bottom:1.5rem;}
  .stat-card {padding:1rem;border-radius:12px;text-align:center;font-weight:bold;font-size:0.9rem;box-shadow:0 0 10px rgba(0,0,0,0.3);}
  .blue{background:#007bff;} .green{background:#28a745;} .red{background:#dc3545;} .yellow{background:#ffc107;color:#000;} .purple{background:#6f42c1;}
  .question-card{background:#1e2636;padding:1rem;border-radius:10px;margin-bottom:1rem;}
  .question-card h3{margin-top:0;color:#00b2ff;}
  .options label{display:block;background:#2a3245;margin:0.5rem 0;padding:0.6rem;border-radius:8px;cursor:pointer;transition:0.3s;}
  .options label:hover{background:#3a4560;}
  textarea {width:100%;padding:0.6rem;margin-top:0.5rem;border-radius:8px;background:#2a3245;color:#fff;border:none;resize:vertical;}
  .submit-btn{background:#00b2ff;border:none;color:white;padding:0.7rem 1.2rem;border-radius:10px;cursor:pointer;font-size:1rem;display:block;width:100%;margin-top:1.2rem;}
  .submit-btn:hover{opacity:0.9;}
  .result-card{background:#1e2636;padding:1.5rem;border-radius:10px;margin-top:1.5rem;text-align:center;}
  .result-card h2{color:#00b2ff;margin-bottom:1rem;}
</style>
</head>
<body>
  <header><h1>ğŸ§  Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h1></header>

  <div class="exam-container">
    <div id="examTitle" class="exam-title">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <div class="stats-bar">
      <div class="stat-card blue">â± Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="timer">--:--</span></div>
      <div class="stat-card purple">ğŸ§© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: <span id="totalQ">0</span></div>
      <div class="stat-card yellow">ğŸ“ Ø§Ù„Ù…Ø¬Ø§Ø¨Ø©: <span id="answeredQ">0</span></div>
      <div class="stat-card green">âœ”ï¸ Ø§Ù„ØµØ­ÙŠØ­Ø©: <span id="correctQ">0</span></div>
      <div class="stat-card red">âŒ Ø§Ù„Ø®Ø§Ø·Ø¦Ø©: <span id="wrongQ">0</span></div>
      <div class="stat-card blue">â³ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: <span id="elapsedTime">0:00</span></div>
    </div>

    <form id="examForm"></form>
    <div id="resultSection"></div>
  </div>

<script type="module">
/* ------------ Firebase ------------ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, get, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDW80ZbwOB7QHHW76kSL9cqlzMoyPFZ7nI",
  authDomain: "ylearn-fe1fa.firebaseapp.com",
  databaseURL: "https://ylearn-fe1fa-default-rtdb.firebaseio.com",
  projectId: "ylearn-fe1fa",
  storageBucket: "ylearn-fe1fa.firebasestorage.app",
  messagingSenderId: "1092852055944",
  appId: "1:1092852055944:web:85c3df7cf4c0cbcdca043d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
await setPersistence(auth, browserLocalPersistence);

/* ------------ Params & Elements ------------ */
const params = new URLSearchParams(window.location.search);
const courseId = params.get("courseId");
const examId = params.get("examId");

const examTitleEl = document.getElementById("examTitle");
const examForm = document.getElementById("examForm");
const resultSection = document.getElementById("resultSection");
const totalQEl = document.getElementById("totalQ");
const answeredQEl = document.getElementById("answeredQ");
const correctQEl = document.getElementById("correctQ");
const wrongQEl = document.getElementById("wrongQ");
const elapsedEl = document.getElementById("elapsedTime");

let timerInterval, elapsedInterval, totalSeconds, startTime;

/* ============================================
      Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠ (Local Processing)
=============================================== */
function gradeEssay(studentAnswer, modelAnswer) {
  if (!studentAnswer || !modelAnswer) return false;
  const clean = (text) => text.replace(/[^\u0600-\u06FF0-9 ]/g, "").trim().split(/\s+/);
  const studentWords = clean(studentAnswer);
  const modelWords = clean(modelAnswer);
  if (studentWords.length === 0) return false;
  let matchCount = 0;
  studentWords.forEach((word) => { if (modelWords.includes(word)) matchCount++; });
  return (matchCount / studentWords.length) >= 0.70; 
}

/* ============================================
            ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆØ­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
=============================================== */
onAuthStateChanged(auth, async (user) => {
  if (!user) return (window.location.href = "login.html");

  // ÙØ­Øµ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ get()
  const resultSnap = await get(ref(db, `results/${user.uid}/${examId}`));
  if (resultSnap.exists()) {
    alert("âœ… Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø§Ù„ÙØ¹Ù„.");
    window.location.href = "dashboard.html";
    return;
  }

  // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
  const examSnap = await get(ref(db, `courses/${courseId}/content/${examId}`));
  if (!examSnap.exists()) {
    examTitleEl.textContent = "âŒ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
    return;
  }

  const exam = examSnap.val();
  const questions = exam.questions || {};
  renderExam(exam, questions, user);
});

function renderExam(exam, questions, user) {
  examTitleEl.textContent = exam.title || "Ø§Ù…ØªØ­Ø§Ù†";
  totalSeconds = (exam.time || 10) * 60;
  startTime = Date.now();
  totalQEl.textContent = Object.keys(questions).length;

  examForm.innerHTML = "";
  Object.entries(questions).forEach(([qid, q]) => {
    const div = document.createElement("div");
    div.className = "question-card";
    
    let inputField = "";
    if (q.type === "Ø§Ø®ØªÙŠØ§Ø±ÙŠ") {
      inputField = Object.values({ opt1: q.opt1, opt2: q.opt2, opt3: q.opt3, opt4: q.opt4 })
        .filter(Boolean)
        .map(opt => `<label><input type="radio" name="${qid}" value="${opt}"> ${opt}</label>`).join("");
    } else {
      inputField = `<textarea name="${qid}" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..."></textarea>`;
    }

    div.innerHTML = `<h3>${q.question}</h3><small style="color:#bbb">Ø§Ù„Ø¯Ø±Ø¬Ø©: ${q.mark || 1}</small><div class="options">${inputField}</div>`;
    examForm.appendChild(div);
  });

  const submitBtn = document.createElement("button");
  submitBtn.className = "submit-btn";
  submitBtn.type = "button";
  submitBtn.textContent = "ğŸ“¤ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†";
  submitBtn.onclick = () => finishExam(user, questions, exam.title || "Ø§Ù…ØªØ­Ø§Ù†");
  examForm.appendChild(submitBtn);

  startTimer(user, questions);
  startElapsedTimer();
}

/* ============================================
              Timer Logic
=============================================== */
function startTimer(user, questions) {
  timerInterval = setInterval(() => {
    if (totalSeconds <= 0) {
      clearInterval(timerInterval);
      finishExam(user, questions, "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª");
    } else {
      totalSeconds--;
      const m = Math.floor(totalSeconds / 60);
      const s = totalSeconds % 60;
      document.getElementById("timer").textContent = `${m}:${s.toString().padStart(2, "0")}`;
    }
  }, 1000);
}

function startElapsedTimer() {
  elapsedInterval = setInterval(() => {
    const diff = Math.floor((Date.now() - startTime) / 1000);
    elapsedEl.textContent = `${Math.floor(diff / 60)}:${(diff % 60).toString().padStart(2,"0")}`;
  }, 1000);
}

/* ============================================
             Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆØ­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©
=============================================== */
async function finishExam(user, questions, examTitle) {
  clearInterval(timerInterval);
  clearInterval(elapsedInterval);

  let correctPoints = 0;
  let wrongCount = 0;

  Object.entries(questions).forEach(([id, q]) => {
    if (q.type === "Ø§Ø®ØªÙŠØ§Ø±ÙŠ") {
      const chosen = document.querySelector(`input[name="${id}"]:checked`);
      if (chosen && chosen.value === q.correct) correctPoints += Number(q.mark || 1);
      else if (chosen) wrongCount++;
    } else {
      const ans = document.querySelector(`textarea[name="${id}"]`)?.value.trim();
      if (ans && gradeEssay(ans, q.modelAnswer || "")) correctPoints += Number(q.mark || 1);
      else if (ans) wrongCount++;
    }
  });

  const totalMarks = Object.values(questions).reduce((sum, q) => sum + Number(q.mark || 1), 0);
  const timeTakenMin = ((Date.now() - startTime) / 60000).toFixed(1);

  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙˆØ±Ø§Ù‹ (ØªØ¬Ø±Ø¨Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø±ÙŠØ¹Ø©)
  examForm.innerHTML = `<div class="result-card"><h2>Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ù†ØªÙŠØ¬ØªÙƒ...</h2></div>`;

  try {
    const userSnap = await get(ref(db, `users/${user.uid}`));
    const userData = userSnap.val() || {};

    const finalData = {
      studentName: userData.fullName || "Ù…Ø¬Ù‡ÙˆÙ„",
      studentPhone: userData.studentNumber || "-",
      examTitle: examTitle,
      score: correctPoints,
      total: totalMarks,
      timeTakenMin,
      createdAt: serverTimestamp() // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆÙ‚Øª Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©
    };

    // Ø­ÙØ¸ ÙÙŠ Ù…ÙƒØ§Ù†ÙŠÙ† Ù„Ø¶Ù…Ø§Ù† ÙˆØµÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø£Ø¯Ù…Ù† ÙˆÙ„Ù„Ø·Ø§Ù„Ø¨
    await Promise.all([
        set(ref(db, `results/${user.uid}/${examId}`), finalData),
        set(ref(db, `grades/${user.uid}/${examId}`), finalData)
    ]);

    resultSection.innerHTML = `
      <div class="result-card">
        <h2>ğŸ¯ Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
        <p style="font-size:1.5rem; color:#00b2ff;">${correctPoints} / ${totalMarks}</p>
        <p>â³ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: ${timeTakenMin} Ø¯Ù‚ÙŠÙ‚Ø©</p>
        <button class="submit-btn" onclick="window.location.href='dashboard.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù†ØµØ©</button>
      </div>
    `;
    alert("ğŸ’¬ THE GIANT says: ØªÙ… Ø­ÙØ¸ Ø¯Ø±Ø¬ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­! ğŸ¯");
  } catch (error) {
    alert("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
    console.error(error);
  }
}
</script>
</body>
</html>