<!doctype html>
<html lang="ar" dir="rtl">                  
<head>                  
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />                  
  <title>   - THE GIANT</title>                  
  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  
  <style>                  
    :root {                  
      --bg: #0b0f19;
      --card: #111827;
      --accent: #00b2ff;                  
      --accent-gradient: linear-gradient(90deg, #00b2ff, #7ee8fa, #00b2ff);
      --muted: #64748b; 
      --ok: #10b981; 
      --danger: #ef4444; 
      --glass-border: rgba(0, 178, 255, 0.2);
    }                  

    body {                  
        margin: 0;
        font-family: 'Cairo', sans-serif;
        background-color: var(--bg);
        color: #fff;
        direction: rtl;
        overflow-x: hidden;
        opacity: 0;
        animation: fadeIn 1.2s ease-in forwards;
    }
    @keyframes fadeIn { to { opacity: 1; } }

    header {                  
      background-color: #0b0f19;
      display: flex; justify-content: space-between; align-items: center;                  
      padding: 1rem 1.5rem; position: sticky; top: 0; z-index: 1000;
      border-bottom: 1px solid var(--glass-border);
    }

    .logo { display: flex; align-items: center; gap: 0.5rem; }
    .logo img { width: 45px; height: 45px; }
    .logo h1 {
        font-size: 1.6rem;
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-family: 'Orbitron', sans-serif;
        margin: 0; font-weight: 800;
        letter-spacing: 1px; text-transform: uppercase;
    }

    .menu-icon { font-size: 1.8rem; cursor: pointer; color: #fff; }

    .main { max-width: 1000px; margin: 20px auto; padding: 0 15px; text-align: center; }                  

    .banner {                  
      background: linear-gradient(145deg, #111827, #0d1320);
      color: var(--accent);
      padding: 2rem 1.5rem; border-radius: 15px; font-weight: bold; font-size: 1.3rem;                  
      margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      border: 1px solid var(--glass-border);
    }

    /*     */
    #teacherProfile {
      display: none; background: var(--card); border: 1px solid var(--accent);
      border-radius: 15px; padding: 15px; margin-bottom: 18px;
      align-items: center; gap: 15px; text-align: right;
    }
    .t-avatar { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--accent); object-fit: cover; }
    .t-info h2 { margin: 0; color: var(--accent); font-size: 1.15rem; }

    .controls-container {
      background: var(--card); padding: 20px; border-radius: 15px; margin-top: 20px;
      border: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 15px;
    }
    .search-input, select { 
      width: 100%; padding: 12px; border-radius: 10px; 
      border: 1px solid #1e293b; background: #0b0f19; color: #fff; 
      font-size: 0.9rem; box-sizing: border-box;
    }

    /*        */
    .course-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 25px; }                  
    .course-card { 
        background: #111827; border-radius: 18px; overflow: hidden; 
        border: 1px solid var(--glass-border); transition: 0.3s; 
        display: flex; flex-direction: column; text-align: right;
    }                  
    .course-card:hover { transform: translateY(-10px); border-color: var(--accent); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .card-header { padding: 15px; }
    .course-card h3 { color: var(--accent); margin: 5px 0; }
    .price-tag { color: var(--ok); font-weight: bold; font-size: 1.1rem; }

    .btn { border: 0; padding: 12px; border-radius: 10px; width: 100%; cursor: pointer; font-weight: 700; transition: 0.3s; font-family: 'Cairo'; }                  
    .buy-btn { background: var(--accent); color: #fff; }                  
    .view-btn { background: #059669; color: #fff; }                  

    /*    */
    .menu {
        position: fixed; top: 0; right: -280px; background-color: #111827;
        width: 260px; height: 100%; box-shadow: -2px 0 10px rgba(0,0,0,0.5);
        display: flex; flex-direction: column; align-items: center;
        padding-top: 5rem; transition: right 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        z-index: 999; border-left: 2px solid var(--accent);
    }
    .menu.active { right: 0; }
    .menu a {
        color: #fff; text-decoration: none; font-size: 1.1rem; margin: 0.5rem 0;
        background-color: var(--accent); padding: 0.7rem 1.5rem;
        border-radius: 8px; transition: 0.3s; width: 80%; text-align: center;
    }

    /*  ( ) */
    .modal { 
        position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); 
        display: none; align-items: center; justify-content: center; z-index: 2000;
    }
    .modal .box { background: #0b0f19; border-radius: 20px; padding: 25px; width: 90%; max-width: 450px; border: 1px solid var(--accent); }

    #loader { padding: 40px; }
    .spinner { width: 40px; height: 40px; border: 4px solid rgba(0,178,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 600px) { .logo h1 { font-size: 1.2rem; } }
  </style>                  
</head>                  
<body>                  

<header>                  
  <div class="menu-icon" id="menuToggle"></div>
  <div class="logo">
    <img src="logo.png" alt="THE GIANT">
    <h1>THE GIANT</h1>                  
  </div>
  <div id="themeToggle" style="visibility: hidden;"></div> </header>                  

<div class="menu" id="sideMenu">
    </div>

<div class="main">                  
  <div class="banner" id="bannerText">    ... </div>

  <div id="teacherProfile">
    <img src="" id="teacherImg" class="t-avatar" alt="M">
    <div class="t-info">
      <h2 id="teacherName"> </h2>
      <p id="teacherSubject" style="margin:0; font-size:0.9rem; color:#ccc;"> </p>
      <div style="font-size: 0.8rem; color: var(--muted); margin-top:5px;">
         : <span id="assistantPhone" style="color:#fff">--</span>
      </div>
    </div>
  </div>

  <div class="controls-container">
    <input type="text" id="searchInput" class="search-input" placeholder="      ...">
    <select id="teacherSelect"><option value="">--   --</option></select>
  </div>                  
  
  <div id="loader"><div class="spinner"></div><p>  ...</p></div>
  <div id="coursesContainer" class="course-grid"></div>                  
</div>

<div id="buyModal" class="modal">                  
  <div class="box">                  
    <h3 id="modalCourseTitle" style="color: var(--accent);"> </h3>
    <p style="font-size: 0.9rem;">      (<strong id="modalPrice">0</strong> .) : <br> <strong style="color:var(--accent); font-size:1.2rem;">01289050156</strong></p>
    <input type="text" id="activationCodeInput" class="search-input" style="text-align:center; letter-spacing:2px;" placeholder="   ">
    <div id="applyResult" style="margin:10px 0; font-size:0.85rem;"></div>
    <div style="display:flex; gap:10px; margin-top:20px;">
        <button id="applyCodeBtn" class="btn buy-btn"> </button>
        <button id="closeModalBtn" class="btn" style="background:#374151; color:#fff;"></button>
    </div>
  </div>                  
</div>

<script type="module">                
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";                  
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";                  
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {    
  apiKey: "AIzaSyDW80ZbwOB7QHHW76kSL9cqlzMoyPFZ7nI", authDomain: "ylearn-fe1fa.firebaseapp.com",    
  databaseURL: "https://ylearn-fe1fa-default-rtdb.firebaseio.com", projectId: "ylearn-fe1fa",    
  storageBucket: "ylearn-fe1fa.appspot.com", messagingSenderId: "1092852055944", appId: "1:1092852055944:web:85c3df7cf4c0cbcdca043d"    
};

const app = initializeApp(firebaseConfig); 
const auth = getAuth(app); 
const db = getDatabase(app);  

const sideMenu = document.getElementById('sideMenu');
const menuToggle = document.getElementById('menuToggle');
const teacherSelect = document.getElementById('teacherSelect');
const searchInput = document.getElementById('searchInput');
const loader = document.getElementById('loader');
const coursesContainer = document.getElementById('coursesContainer');

//   
menuToggle.onclick = () => {
    sideMenu.classList.toggle('active');
    menuToggle.textContent = sideMenu.classList.contains('active') ? '' : '';
};

let currentCourse = null, currentUid = null, studentGrade = null, allTeachers = {}, allCourses = {};

onAuthStateChanged(auth, async (user) => {
  if (!user) return (window.location.href = 'login.html');
  currentUid = user.uid;
  
  const userSnap = await get(ref(db, `users/${currentUid}`));
  const userData = userSnap.val() || {};
  studentGrade = userData.grade || null; 
  document.getElementById('bannerText').textContent = ` ${userData.fullName || ' '}! `;

  //   
  sideMenu.innerHTML = `
    <div style="padding:1rem; color:var(--accent)"> </div>
    <a href="index.html"> </a>
    <a href="performance.html">  </a>
    <a href="freevid.html">  </a>
    <a href="#" id="logoutBtn" style="background:#ef4444">  </a>
  `;
  document.getElementById('logoutBtn').onclick = () => confirm("") && signOut(auth).then(()=>location.reload());
  
  loader.style.display = 'block';
  const [tSnap, cSnap] = await Promise.all([get(ref(db, 'teachers')), get(ref(db, 'courses'))]);
  allTeachers = tSnap.val() || {}; allCourses = cSnap.val() || {};
  loader.style.display = 'none';

  teacherSelect.innerHTML = '<option value="">--   --</option>';
  Object.entries(allTeachers).forEach(([id, t]) => {
    if (studentGrade && t.grade === studentGrade) {
      const opt = document.createElement('option'); opt.value = id; opt.textContent = t.name;
      teacherSelect.appendChild(opt);
    }
  });

  teacherSelect.onchange = () => { displayTeacherInfo(); loadVisibleCourses(); };
  searchInput.oninput = loadVisibleCourses;
});

function displayTeacherInfo() {
    const tid = teacherSelect.value;
    const profile = document.getElementById('teacherProfile');
    if (tid && allTeachers[tid]) {
        const t = allTeachers[tid];
        document.getElementById('teacherName').textContent = t.name;
        document.getElementById('teacherSubject').textContent = t.subject || " ";
        document.getElementById('teacherImg').src = t.photoUrl || "logo.png";
        document.getElementById('assistantPhone').textContent = t.secretaryPhone || t.phone || "--";
        profile.style.display = 'flex';
    } else { profile.style.display = 'none'; }
}

async function loadVisibleCourses() {
  const tid = teacherSelect.value, term = searchInput.value.toLowerCase().trim();
  coursesContainer.innerHTML = ''; if (!tid && !term) return;
  loader.style.display = 'block';
  
  const [pSnap, vSnap] = await Promise.all([
      get(ref(db, `students/${currentUid}/purchased`)), 
      get(ref(db, `grades/${studentGrade}/videos`))
  ]);
  
  const purchased = pSnap.val() || {}, gVideos = vSnap.val() || {};

  for (const [id, c] of Object.entries(allCourses)) {
    if ((tid && c.teacherId !== tid && !term) || (term && !c.name.toLowerCase().includes(term))) continue;
    renderCard(id, c, purchased[id], false); 
  }
  for (const [id, v] of Object.entries(gVideos)) {
    if ((term && !v.title.toLowerCase().includes(term)) || (!tid && !term)) continue;
    renderCard(id, { name: v.title, description: v.note, price: v.price }, purchased[id], true);
  }
  loader.style.display = 'none';
}

function renderCard(id, c, isP, isL) {
  const isF = (!c.price || Number(c.price) === 0);
  const card = document.createElement('div'); card.className = 'course-card';
  card.innerHTML = `
    <div class="card-header"><h3>${c.name}</h3></div>
    <div style="padding:0 15px 15px; flex-grow:1;">
        <p style="font-size:0.85rem; color:#ccc; height:40px; overflow:hidden;">${c.description || '  '}</p>
        <div class="price-tag">${isF ? ' ' : c.price + ' .'}</div>
    </div>
    <div style="padding:15px; border-top:1px solid var(--glass-border)">
        <button class="btn ${isP || isF ? 'view-btn' : 'buy-btn'}">${isP || isF ? '' : ' '}</button>
    </div>`;
  card.querySelector('button').onclick = () => {
    if (isP || isF) window.location.href = isL ? `view.html?lessonId=${id}&grade=${studentGrade}` : `courseContent.html?courseId=${id}`;
    else openBuyModal({ id, name: c.name, price: c.price });
  };
  coursesContainer.appendChild(card);
}

function openBuyModal(course) {
  currentCourse = course;
  document.getElementById('modalCourseTitle').textContent = course.name;
  document.getElementById('modalPrice').textContent = course.price;
  document.getElementById('buyModal').style.display = 'flex';
}
document.getElementById('closeModalBtn').onclick = () => document.getElementById('buyModal').style.display = 'none';

document.getElementById('applyCodeBtn').onclick = async () => {
  const code = document.getElementById('activationCodeInput').value.trim().toUpperCase();
  if (!code) return;
  const res = document.getElementById('applyResult');
  res.textContent = " ...";

  const used = await get(ref(db, `usedCodes/${code}`));
  if (used.exists()) { res.style.color = 'red'; res.textContent = " !"; return; }

  //    (   )
  const prefix = currentCourse.id.slice(-5).toUpperCase();
  let isValid = false;
  for (let i = 1; i <= 2000; i++) {
      if (code.includes(prefix) && code.includes((2000 + i).toString())) { isValid = true; break; }
  }

  if (isValid) {
      await set(ref(db, `usedCodes/${code}`), { uid: currentUid, at: new Date().toISOString() });
      await set(ref(db, `students/${currentUid}/purchased/${currentCourse.id}`), true);
      res.style.color = 'green'; res.textContent = "  !";
      setTimeout(()=>location.reload(), 1000);
  } else {
      res.style.color = 'red'; res.textContent = " !";
  }
};
</script>
</body>
</html>
