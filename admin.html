<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† | THE GIANT</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {--bg:#0b0f19;--card:#111827;--accent:#00b2ff;--ok:#10b981;--danger:#ef4444;--muted:#94a3b8;}
*{box-sizing:border-box}
body{background:var(--bg);color:#fff;font-family:"Cairo",sans-serif;margin:0;padding:20px;-webkit-font-smoothing:antialiased;}
h1{text-align:center;color:var(--accent);margin:0 0 20px 0; font-weight: 900;}

.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;}
.card{background:var(--card);border-radius:18px;padding:1.5rem;text-align:center;transition:0.3s;cursor:pointer;box-shadow:0 10px 25px rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.05); position: relative;}
.card:hover{transform:translateY(-5px);border-color:var(--accent);background:#161e2d;}
.card h2{color:var(--accent);margin:0 0 5px; font-size: 1.2rem;}
.card p{color:var(--muted);margin:0; font-size: 0.85rem;}
.student-count-badge { background: var(--ok); color: #fff; padding: 2px 12px; border-radius: 20px; font-weight: bold; font-size: 0.75rem; margin-top: 8px; display: inline-block; }

#notifBtn{position:fixed;bottom:20px;left:20px;background:var(--accent);border:none;border-radius:50%;width:60px;height:60px;color:#fff;font-size:25px;cursor:pointer;z-index:100;box-shadow: 0 5px 15px rgba(0,178,255,0.4);}

.modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:200;backdrop-filter: blur(5px);}
.modal .box{background:var(--card);border-radius:24px;padding:20px;width:95%;max-width:1100px;max-height:90vh;overflow:hidden; display:flex; flex-direction:column; border:1px solid rgba(255,255,255,0.1);}

.tabs{display:flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none;}
.tabs button{background:#1e2636;color:var(--muted);border:none;padding:10px 20px;cursor:pointer;border-radius:12px;transition:0.3s;font-weight:bold; font-family: 'Cairo'; white-space: nowrap;}
.tabs button.active{background:var(--accent);color:#fff;}

.tab-content{display:none; overflow-y: auto; flex: 1; padding-right: 5px;}
.tab-content.active{display:block;}

.req{background:rgba(255,255,255,0.02);border-radius:15px;padding:15px;margin-bottom:12px; border: 1px solid rgba(255,255,255,0.05); position: relative;}
.req p{margin:4px 0; font-size:0.9rem;}
.req strong{color:var(--accent);}

.codes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; margin-top: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; max-height: 400px; overflow-y: auto; direction: ltr; }
.code-box { background: #0b0f19; border: 1px solid #1e2636; color: var(--muted); padding: 8px; border-radius: 8px; font-size: 11px; text-align: center; font-family: monospace; cursor: pointer; transition: 0.2s; }
.code-box:hover { border-color: var(--accent); color: var(--accent); }
.code-box[data-used="true"] { opacity: 0.4; border-color: var(--danger); color: var(--danger); text-decoration: line-through; order: 2; }
.code-box[data-used="false"] { order: 1; border-color: var(--ok); color: var(--ok); font-weight: bold;}

.load-more-btn { background: #1e2636; color: var(--accent); border: 1px solid var(--accent); padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 13px; font-family: 'Cairo'; margin: 15px auto; display: block; width: fit-content; font-weight: bold; }
.load-more-btn:hover { background: var(--accent); color: #fff; }

.btn-export { background: var(--ok); color: white; border: none; padding: 8px 16px; border-radius: 10px; cursor: pointer; font-family: 'Cairo'; font-weight: bold; margin-bottom: 10px; display: inline-flex; align-items: center; gap: 5px; }
.clear-btn { background: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-family: 'Cairo'; font-size: 0.8rem; margin-top: 10px; }

.search-box input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 15px; background: #1e2636; color: white; font-family: "Cairo"; }
.btn-logout { background: var(--danger); color: white; border: none; padding: 12px 30px; border-radius: 15px; cursor: pointer; font-family: 'Cairo'; font-weight: bold; display: block; margin: 20px auto; }
</style>
</head>
<body>

<button id="notifBtn" title="ÙØªØ­ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©">ğŸ«</button>

<h1>ğŸ‘¨â€ğŸ’» Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚</h1>

<div class="dashboard">
  <div class="card" onclick="window.location.href='teachers.html'"><h2>ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</h2><p>Ø¥Ø¯Ø§Ø±Ø© Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³</p></div>
  <div class="card" onclick="window.location.href='courses.html'"><h2>ğŸ“š Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</h2><p>Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© ÙˆØ§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</p></div>
  <div class="card" onclick="window.location.href='content.html'"><h2>ğŸ“– Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h2><p>Ø±ÙØ¹ Ø§Ù„Ø­ØµØµ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª</p></div>
  <div class="card" id="studentsCard">
      <h2>ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
      <p>Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</p>
      <div id="totalStudents" class="student-count-badge">...</div>
  </div>
  <div class="card" onclick="window.location.href='details.html'"><h2>ğŸ“„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2><p>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø´Ø§Ù…Ù„Ø©</p></div>
  <div class="card" onclick="window.location.href='reply.html'"><h2>Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª<h2/><p>Ø±ÙˆÙŠØ© Ù…Ù‚ØªØ±Ø­Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</p></div>
</div>

<button class="btn-logout" id="logoutBtn">ğŸ”’ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

<div id="notifModal" class="modal">
  <div class="box">
    <div class="tabs">
      <button id="tab-codes" class="active">ğŸ« Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ (2000 ÙƒÙˆØ¯)</button>
      <button id="tab-students">ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
      <button id="tab-grades">ğŸ§® Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
      <button id="tab-homeworks">ğŸ“˜ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</button>
      <button id="tab-reviews">â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
    </div>

    <div id="codesTab" class="tab-content active">
        <div class="search-box"><input type="text" id="codeSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³ Ø£Ùˆ Ø§Ù„Ø­ØµØ©..."></div>
        <div id="codesList"></div>
    </div>

    <div id="studentsTab" class="tab-content">
      <div class="search-box"><input type="text" id="studentSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..."></div>
      <div id="studentsList"></div>
    </div>

    <div id="gradesTab" class="tab-content">
      <button class="btn-export" onclick="exportToCSV('grades')">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Excel</button>
      <div id="gradesList"></div>
    </div>

    <div id="homeworksTab" class="tab-content">
      <button class="btn-export" onclick="exportToCSV('homeworks')">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Excel</button>
      <div id="homeworksList"></div>
    </div>

    <div id="reviewsTab" class="tab-content">
      <button class="clear-btn" id="clearReviews">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
      <div id="reviewsList"></div>
    </div>

    <button onclick="closeModal()" style="background:#334155; padding:10px; border:none; border-radius:12px; color:#fff; cursor:pointer; font-family:'Cairo'; margin-top:10px;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, onValue, set, get, remove, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDW80ZbwOB7QHHW76kSL9cqlzMoyPFZ7nI",
    authDomain: "ylearn-fe1fa.firebaseapp.com",
    databaseURL: "https://ylearn-fe1fa-default-rtdb.firebaseio.com",
    projectId: "ylearn-fe1fa",
    storageBucket: "ylearn-fe1fa.appspot.com",
    messagingSenderId: "1092852055944",
    appId: "1:1092852055944:web:85c3df7cf4c0cbcdca043d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

onAuthStateChanged(auth, (user) => {
    if (!user || user.uid !== "lSpi591awfQMcRFU62CAM3108Hu1") {
        window.location.href = "login.html";
    }
});

document.getElementById("logoutBtn").onclick = () => signOut(auth);

const tabs = ['codes', 'students', 'grades', 'homeworks', 'reviews'];
window.switchTab = (target) => {
    tabs.forEach(t => {
        document.getElementById(`tab-${t}`).classList.toggle('active', t === target);
        document.getElementById(`${t}Tab`).classList.toggle('active', t === target);
    });
    if(target === 'homeworks') loadHomeworks();
    if(target === 'grades') loadGrades();
};
tabs.forEach(t => document.getElementById(`tab-${t}`).onclick = () => switchTab(t));

window.closeModal = () => document.getElementById('notifModal').style.display='none';
document.getElementById('notifBtn').onclick = () => {
    document.getElementById('notifModal').style.display='flex';
    loadCodesData();
};

document.getElementById('clearReviews').onclick = async () => {
    if(confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
        try {
            await remove(ref(db, 'notifications/feedbacks'));
            alert("âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");
        } catch(e) { alert("âŒ Ø®Ø·Ø£."); }
    }
};

// --- Ù†Ø¸Ø§Ù… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ù…Ø¹ "Ø¹Ø±Ø¶ 15 ÙƒÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠ" ---
async function generateCodesForElement(id, name, type, usedSet) {
    const parent = document.createElement('div');
    parent.className = 'req code-item-container';
    parent.setAttribute('data-name', name.toLowerCase());
    const prefix = id.slice(-5).toUpperCase();

    parent.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <p><strong>${type}: ${name}</strong></p>
            <button class="btn-export" style="font-size:10px; padding:4px 8px;">ğŸ“‹ Ù†Ø³Ø® Ø£ÙˆÙ„ ÙƒÙˆØ¯ Ù…ØªØ§Ø­</button>
        </div>
        <div class="codes-grid"></div>
        <div style="text-align:center;">
             <button class="load-more-btn">ğŸ”½ Ø¹Ø±Ø¶ 15 ÙƒÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠ</button>
        </div>
    `;

    const grid = parent.querySelector('.codes-grid');
    const loadMoreBtn = parent.querySelector('.load-more-btn');
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';

    const getFixedSuffix = (idx, seed) => {
        let hash = 0;
        for (let i = 0; i < seed.length; i++) hash = ((hash << 5) - hash) + seed.charCodeAt(i);
        hash += idx;
        let res = '';
        for (let j = 0; j < 3; j++) {
            hash = (hash * 16807) % 2147483647;
            res += chars.charAt(Math.abs(hash) % chars.length);
        }
        return res;
    };

    let displayedCount = 0;
    const batchSize = 15; // ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªØ¸Ù‡Ø± 15 ÙƒÙˆØ¯Ø§Ù‹ ÙÙ‚Ø·

    const renderNextBatch = () => {
        const fragment = document.createDocumentFragment();
        const start = displayedCount + 1;
        const end = Math.min(displayedCount + batchSize, 2000);

        for (let i = start; i <= end; i++) {
            const suffix = getFixedSuffix(i, id);
            const code = `GIANT-${prefix}-${2000 + i}-${suffix}`;
            const isUsed = usedSet.has(code);
            
            const cDiv = document.createElement('div');
            cDiv.className = 'code-box';
            cDiv.setAttribute('data-used', isUsed);
            cDiv.innerText = isUsed ? `ğŸš© ${code}` : code;
            
            cDiv.onclick = (e) => {
                e.stopPropagation();
                navigator.clipboard.writeText(code);
                alert(isUsed ? "Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù…!" : "ØªÙ… Ø§Ù„Ù†Ø³Ø®: " + code);
            };
            fragment.appendChild(cDiv);
        }
        
        grid.appendChild(fragment);
        displayedCount = end;

        if (displayedCount >= 2000) {
            loadMoreBtn.style.display = 'none';
        }
    };

    renderNextBatch(); // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ 15

    loadMoreBtn.addEventListener('click', (e) => {
        e.preventDefault();
        renderNextBatch();
    });

    parent.querySelector('.btn-export').onclick = () => {
        const firstFree = grid.querySelector('.code-box[data-used="false"]');
        if (firstFree) {
            navigator.clipboard.writeText(firstFree.innerText);
            alert("ØªÙ… Ù†Ø³Ø®: " + firstFree.innerText);
        } else {
            alert("Ø§Ø¶ØºØ· Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙƒÙˆØ§Ø¯ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…Ø©.");
        }
    };

    return parent;
}

async function loadCodesData() {
    const container = document.getElementById('codesList');
    if (container.children.length > 0) return;
    container.innerHTML = '<p style="text-align:center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯... ğŸš€</p>';
    
    const [coursesSnap, gradesSnap, usedSnap] = await Promise.all([
        get(ref(db, 'courses')), get(ref(db, 'grades')), get(ref(db, 'usedCodes'))
    ]);
    
    const usedSet = new Set(usedSnap.exists() ? Object.keys(usedSnap.val()) : []);
    const frag = document.createDocumentFragment();

    if(coursesSnap.exists()) {
        for (const [id, c] of Object.entries(coursesSnap.val())) {
            if (Number(c.price) > 0) frag.appendChild(await generateCodesForElement(id, c.name, 'ğŸ“š ÙƒÙˆØ±Ø³', usedSet));
        }
    }
    
    if(gradesSnap.exists()) {
        for (const [gradeId, data] of Object.entries(gradesSnap.val())) {
            if(data.videos) {
                for (const [vId, v] of Object.entries(data.videos)) {
                    if (v.price > 0) frag.appendChild(await generateCodesForElement(vId, v.title, `ğŸ“– Ø­ØµØ© (${gradeId})`, usedSet));
                }
            }
        }
    }
    setTimeout(() => { container.innerHTML = ''; container.appendChild(frag); }, 500);
}

// Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª (Ø§Ù„Ø·Ù„Ø§Ø¨ØŒ Ø§Ù„Ø¯Ø±Ø¬Ø§ØªØŒ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª) ÙŠØ¸Ù„ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
onValue(ref(db,'notifications/feedbacks'),s=>{
    const reviewsList = document.getElementById('reviewsList');
    reviewsList.innerHTML='';
    if(!s.exists()){reviewsList.innerHTML='<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª.</p>';return;}
    for(const [id,r] of Object.entries(s.val())){
        const d=document.createElement('div');
        d.className='req';
        d.innerHTML=`<p>â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${r.rating||'-'}</p><p>ğŸ’¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚: ${r.message||'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p><p>ğŸ“… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚: ${r.timestamp||'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>`;
        reviewsList.appendChild(d);
    }
});

onValue(ref(db, "users"), async snap => {
    if(!snap.exists()) return;
    const users = snap.val();
    document.getElementById("totalStudents").innerText = Object.keys(users).length + " Ø·Ø§Ù„Ø¨";
    const [studentsSnap, coursesSnap, gradesSnap] = await Promise.all([get(ref(db, "students")), get(ref(db, "courses")), get(ref(db, "grades"))]);
    const allPurchases = studentsSnap.val() || {};
    const mainCourses = coursesSnap.val() || {};
    const gradesData = gradesSnap.val() || {};
    const namesDictionary = {};
    Object.entries(mainCourses).forEach(([id, data]) => { namesDictionary[id] = data.name; });
    Object.values(gradesData).forEach(grade => { if (grade.videos) Object.entries(grade.videos).forEach(([vId, vData]) => { namesDictionary[vId] = vData.title; }); });

    const container = document.getElementById('studentsList');
    container.innerHTML = '';
    window.allStudentsData = [];

    Object.entries(users).forEach(([uid, user]) => {
        const userPurchasedObj = allPurchases[uid]?.purchased || {};
        const courseNames = Object.keys(userPurchasedObj).map(id => namesDictionary[id] || "Ø¹Ù†ØµØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");
        const div = document.createElement("div");
        div.className = "req";
        div.innerHTML = `<p>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: <strong style="color:var(--accent)">${user.fullName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}</strong></p>
            <p>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${user.studentNumber || "-"}</p>
            <p>ğŸ“± Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${user.parentNumber || "-"}</p>
            <p>ğŸ“ Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${user.grade || "-"}</p>
            <p style="margin-top:10px; font-weight:bold;">ğŸ“˜ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (ÙƒÙˆØ±Ø³Ø§Øª ÙˆØ­ØµØµ):</p>
            <ul style="color:#00b2ff; background:rgba(255,255,255,0.03); border-radius:12px; padding:10px 25px; margin:5px 0;">
                ${courseNames.length > 0 
                    ? courseNames.map(n => `<li style="margin-bottom:5px; font-size:0.9rem;">${n}</li>`).join("") 
                    : "<li style='color:#666; list-style:none;'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª</li>"}
            </ul>`;
        container.appendChild(div);
        window.allStudentsData.push({ el: div, search: (user.fullName + user.studentNumber).toLowerCase() });
    });
});

window.exportToCSV = (type) => {
    let csv = "\ufeffØ§Ù„Ø§Ø³Ù…,Ø§Ù„Ù‡Ø§ØªÙ,Ø§Ù„Ø¯Ø±Ø¬Ø©\n";
    document.querySelectorAll(`#${type === 'grades' ? 'gradesList' : 'homeworksList'} .req`).forEach(el => {
        const row = Array.from(el.querySelectorAll('p')).map(p => `"${p.innerText.split(': ')[1]}"`).join(",");
        csv += row + "\n";
    });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
    link.download = `${type}.csv`; link.click();
};

async function loadGrades() {
    const container = document.getElementById('gradesList'); container.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
    const snap = await get(ref(db, 'results')); container.innerHTML = '';
    if(!snap.exists()) return;
    Object.values(snap.val()).forEach(u => Object.values(u).forEach(g => {
        const d = document.createElement('div'); d.className = 'req';
        d.innerHTML = `<p>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${g.studentName||'-'}</p><p>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${g.studentPhone||'-'}</p><p>ğŸ“± Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${g.parentPhone||'-'}</p><p>ğŸ§¾ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†: ${g.examTitle||'-'}</p><p>ğŸ“Š Ø§Ù„Ø¯Ø±Ø¬Ø©: ${g.score||0} / ${g.total||0}</p><p>â³ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: ${g.timeTakenMin || 0}</p>`;
        container.appendChild(d);
    }));
}

async function loadHomeworks() {
    const container = document.getElementById('homeworksList'); container.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
    const snap = await get(ref(db, 'homeworkResult')); container.innerHTML = '';
    if(!snap.exists()) return;
    Object.values(snap.val()).forEach(u => Object.values(u).forEach(h => {
        const d = document.createElement('div'); d.className = 'req';
        d.innerHTML = `<p>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${h.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
        <p>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${h.phone || '-'}</p>
        <p>ğŸ“± Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${h.parentPhone || '-'}</p>
        <p>ğŸ“˜ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ§Ø¬Ø¨: ${h.title || '-'}</p>
        <p>âœ… ØµØ­ÙŠØ­Ø©: ${h.correct || 0}</p>
        <p>âŒ Ø®Ø§Ø·Ø¦Ø©: ${h.wrong || 0}</p>
        <p>ğŸ“Š Ø§Ù„Ù†Ø³Ø¨Ø©: ${h.percentage || 0}%</p>
        <p>ğŸ§® Ø§Ù„Ø¯Ø±Ø¬Ø©: ${h.score || 0} / ${h.total || 0}</p>
        <p>â³ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: ${h.timeTakenMin || 0} Ø¯Ù‚ÙŠÙ‚Ø©</p>`;
        container.appendChild(d);
    }));
}

document.getElementById("studentSearch").oninput = (e) => {
    const val = e.target.value.toLowerCase();
    window.allStudentsData.forEach(s => s.el.style.display = s.search.includes(val) ? "block" : "none");
};

document.getElementById("codeSearch").oninput = (e) => {
    const val = e.target.value.toLowerCase();
    document.querySelectorAll('.code-item-container').forEach(item => {
        item.style.display = item.getAttribute('data-name').includes(val) ? 'block' : 'none';
    });
};

document.getElementById("studentsCard").onclick = () => { document.getElementById('notifModal').style.display='flex'; switchTab('students'); };
</script>
</body>
</html>
